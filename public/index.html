<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Polytrade Paper Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b1220;
        --panel: #111a2f;
        --muted: #7f8ba6;
        --text: #e8f0ff;
        --accent: #68d4ff;
        --accent-2: #9f7aea;
        --card: linear-gradient(135deg, #121c33, #0f1628 55%, #121c33);
        --success: #2dd4bf;
        --danger: #f472b6;
        --warning: #fbbf24;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: radial-gradient(circle at 20% 20%, #102040 0, #0b1220 40%),
          radial-gradient(circle at 80% 0%, #1b2742 0, #0b1220 35%),
          var(--bg);
        color: var(--text);
        font-family: "Space Grotesk", "Segoe UI", sans-serif;
      }
      header {
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        backdrop-filter: blur(10px);
        background: rgba(11, 18, 32, 0.7);
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        z-index: 10;
      }
      .title {
        font-weight: 700;
        letter-spacing: -0.4px;
        font-size: 18px;
      }
      .pill {
        padding: 8px 14px;
        border-radius: 999px;
        background: rgba(104, 212, 255, 0.15);
        color: var(--accent);
        border: 1px solid rgba(104, 212, 255, 0.35);
        font-size: 13px;
      }
      main {
        padding: 18px 24px 32px;
      }
      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.35);
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .metric {
        font-size: 26px;
        font-weight: 700;
        margin-top: 6px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      th,
      td {
        text-align: left;
        padding: 8px 6px;
        font-size: 13px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }
      th {
        color: var(--muted);
        font-weight: 600;
        letter-spacing: 0.2px;
      }
      .tag {
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .badge {
        padding: 6px 10px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 12px;
      }
      .pnlu {
        color: var(--success);
      }
      .pnld {
        color: var(--danger);
      }
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .tab-btn {
        padding: 6px 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        cursor: pointer;
        font-size: 12px;
      }
      .tab-btn.active {
        border-color: var(--accent);
        color: var(--accent);
        background: rgba(104, 212, 255, 0.08);
      }
      canvas {
        max-width: 100%;
      }
      @media (max-width: 640px) {
        header {
          padding: 16px;
        }
        main {
          padding: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">Polytrade Paper Dashboard</div>
      <div class="pill" id="updated">loading…</div>
    </header>
    <main>
      <div class="grid" id="metrics"></div>

      <div class="card" style="margin-top: 14px">
        <div class="row" style="justify-content: space-between; align-items: center">
          <div>
            <div class="muted">Equity Curve</div>
            <div class="metric" style="font-size: 18px">Paper account</div>
          </div>
          <div class="tabs" id="eq-tabs">
            <button class="tab-btn active" data-ival="300">5m</button>
            <button class="tab-btn" data-ival="1800">30m</button>
            <button class="tab-btn" data-ival="3600">1h</button>
            <button class="tab-btn" data-ival="86400">1d</button>
            <button class="tab-btn" data-ival="604800">1w</button>
          </div>
        </div>
        <canvas id="eq-chart" height="120"></canvas>
      </div>

      <div class="card" style="margin-top: 14px">
        <div class="row" style="justify-content: space-between; align-items: center">
          <div>
            <div class="muted">Open Positions</div>
            <div class="metric" style="font-size: 18px">Per-leader allocation view</div>
          </div>
          <div class="badge">Auto-refresh 5s</div>
        </div>
        <table id="positions-table">
          <thead>
            <tr>
              <th>Leader</th>
              <th>Condition</th>
              <th>Size</th>
              <th>Avg Price</th>
              <th>Unrealized</th>
              <th>Opened</th>
              <th>Notional</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top: 14px">
        <div class="row" style="justify-content: space-between; align-items: center">
          <div>
            <div class="muted">Recent Paper Fills</div>
            <div class="metric" style="font-size: 18px">Latest 50</div>
          </div>
        </div>
        <table id="fills-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Leader</th>
              <th>Side</th>
              <th>Size</th>
              <th>Price</th>
              <th>Notional</th>
              <th>Market</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      const fmtUSD = (v) =>
        (v || 0).toLocaleString("en-US", { style: "currency", currency: "USD", maximumFractionDigits: 2 });
      const fmtNum = (v) => Number(v || 0).toLocaleString("en-US", { maximumFractionDigits: 2 });

      async function fetchJSON(path) {
        const res = await fetch(path);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      function renderMetrics(p) {
        const metrics = document.getElementById("metrics");
        metrics.innerHTML = "";
        const cards = [
          { label: "Equity", value: fmtUSD(p.equity), accent: "var(--accent)" },
          { label: "Cash", value: fmtUSD(p.cash), accent: "var(--muted)" },
          { label: "Unrealized", value: fmtUSD(p.unrealized), accent: "var(--warning)" },
          { label: "Realized", value: fmtUSD(p.realized), accent: "var(--success)" },
        ];
        cards.forEach((c) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div class="muted">${c.label}</div>
            <div class="metric" style="color:${c.accent}">${c.value}</div>
          `;
          metrics.appendChild(div);
        });
      }

      function renderPositions(rows) {
        const body = document.querySelector("#positions-table tbody");
        body.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          const opened = r.updated_at ? new Date(Number(r.updated_at)).toLocaleTimeString() : "-";
          tr.innerHTML = `
            <td>${r.leader_wallet.slice(0, 6)}…${r.leader_wallet.slice(-4)}</td>
            <td>${r.title || r.condition_id.slice(0, 8) + "…"}</td>
            <td>${fmtNum(r.size)}</td>
            <td>${fmtNum(r.avg_price)}</td>
            <td>${fmtUSD(r.unrealized ?? 0)}</td>
            <td>${opened}</td>
            <td>${fmtUSD(r.notional)}</td>
          `;
          body.appendChild(tr);
        });
      }

      function renderFills(rows) {
        const body = document.querySelector("#fills-table tbody");
        body.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          const sideColor = r.side === "BUY" ? "var(--success)" : "var(--danger)";
          const date = new Date(r.timestamp).toLocaleTimeString();
          tr.innerHTML = `
            <td>${date}</td>
            <td>${r.leader_wallet.slice(0, 6)}…${r.leader_wallet.slice(-4)}</td>
            <td style="color:${sideColor}">${r.side}</td>
            <td>${fmtNum(r.size)}</td>
            <td>${fmtNum(r.price)}</td>
            <td>${fmtUSD(r.notional)}</td>
            <td>${r.title || r.condition_id.slice(0, 8) + "…"}</td>
          `;
          body.appendChild(tr);
        });
      }

      let eqChart;
      let currentInterval = 300;

      async function loadEquity(intervalSec = 300) {
        const data = await fetchJSON(`/api/equity?intervalSec=${intervalSec}&limit=400`);
        const labels = data.map((d) => new Date(d.timestamp).toLocaleTimeString());
        const values = data.map((d) => d.equity);
        if (!eqChart) {
          const ctx = document.getElementById("eq-chart").getContext("2d");
          eqChart = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Equity",
                  data: values,
                  borderColor: "#68d4ff",
                  backgroundColor: "rgba(104,212,255,0.1)",
                  tension: 0.25,
                  fill: true,
                },
              ],
            },
            options: {
              scales: {
                x: {
                  ticks: { color: "rgba(255,255,255,0.6)", maxTicksLimit: 6 },
                  grid: { display: false },
                },
                y: {
                  ticks: { color: "rgba(255,255,255,0.6)" },
                  grid: { color: "rgba(255,255,255,0.05)" },
                },
              },
              plugins: { legend: { display: false } },
            },
          });
        } else {
          eqChart.data.labels = labels;
          eqChart.data.datasets[0].data = values;
          eqChart.update();
        }
      }

      function bindTabs() {
        const tabs = document.querySelectorAll("#eq-tabs .tab-btn");
        tabs.forEach((btn) => {
          btn.addEventListener("click", () => {
            tabs.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            currentInterval = Number(btn.dataset.ival);
            loadEquity(currentInterval);
          });
        });
      }

      async function refresh() {
        try {
          const [portfolio, positions, fills] = await Promise.all([
            fetchJSON("/api/portfolio"),
            fetchJSON("/api/positions"),
            fetchJSON("/api/fills?limit=50"),
          ]);
          renderMetrics(portfolio);
          renderPositions(positions);
          renderFills(fills);
          await loadEquity(currentInterval);
          document.getElementById("updated").textContent = "Updated " + new Date().toLocaleTimeString();
        } catch (e) {
          document.getElementById("updated").textContent = "Error: " + e.message;
        }
      }

      bindTabs();
      refresh();
      setInterval(refresh, 5000);
    </script>
  </body>
</html>
